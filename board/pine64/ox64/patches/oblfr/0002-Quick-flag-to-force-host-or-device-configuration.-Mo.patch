From 363980dcf98fb4c6555161e376351f73fac82bc9 Mon Sep 17 00:00:00 2001
From: "Grant T. Olson" <kgo@grant-olson.net>
Date: Mon, 13 Feb 2023 08:52:14 -0500
Subject: [PATCH 2/2] Quick flag to force host or device configuration. Move to
 a Kconfig var later

---
 components/usbphy/include/oblfr_usbphy.h | 12 ++++++++++++
 components/usbphy/src/oblfr_usbphy.c     | 17 +++++++++++++++--
 2 files changed, 27 insertions(+), 2 deletions(-)

diff --git a/components/usbphy/include/oblfr_usbphy.h b/components/usbphy/include/oblfr_usbphy.h
index 91d9584..413f6d4 100644
--- a/components/usbphy/include/oblfr_usbphy.h
+++ b/components/usbphy/include/oblfr_usbphy.h
@@ -69,4 +69,16 @@
 
 void bflb_usb_phy_init(void);
 
+// USB REGS
+
+#define USB_GLB_INT_OFFSET          (0xC4)  /* GLB_INT */
+
+
+/* 0xC4 : GLB_INT */
+#define USB_MDEV_INT (1 << 0U)
+#define USB_MOTG_INT (1 << 1U)
+#define USB_MHC_INT  (1 << 2U)
+#define USB_POLARITY (1 << 3U)
+
+
 #endif
diff --git a/components/usbphy/src/oblfr_usbphy.c b/components/usbphy/src/oblfr_usbphy.c
index 8429deb..46f474d 100644
--- a/components/usbphy/src/oblfr_usbphy.c
+++ b/components/usbphy/src/oblfr_usbphy.c
@@ -35,6 +35,11 @@
 #include <arch/risc-v/riscv_arch.h>
 #include <hardware/usb_v2_reg.h>
 #include "oblfr_usbphy.h"
+#define DBG_TAG "USBPHY"
+#include "log.h"
+
+// Enable USB A mode instead of B
+//#define USB_HOST
 
 void bflb_usb_phy_init(void)
 {
@@ -86,11 +91,19 @@ void bflb_usb_phy_init(void)
     putreg32(regval, BFLB_PDS_BASE + PDS_USB_CTL_OFFSET);
 
     bflb_mtimer_delay_ms(2);
-
+    
     regval = getreg32(BFLB_PDS_BASE + PDS_USB_CTL_OFFSET);
-    regval &= ~PDS_REG_USB_DRVBUS_POL;
+    LOG_I("PDS CTL %x\r\n", regval);
+    //regval &= ~PDS_REG_USB_DRVBUS_POL;
+
+#ifdef USB_HOST
     regval &= ~PDS_REG_USB_IDDIG;
+#else
+    regval |= PDS_REG_USB_IDDIG;
+#endif
+    
     putreg32(regval, BFLB_PDS_BASE + PDS_USB_CTL_OFFSET);
 
+    bflb_mtimer_delay_ms(10);
 }
 
-- 
2.34.1

