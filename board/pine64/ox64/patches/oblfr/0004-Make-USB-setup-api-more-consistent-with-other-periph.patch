From 6896ee7fcbd1a11be86d99c4e7cb1d7a53c20663 Mon Sep 17 00:00:00 2001
From: "Grant T. Olson" <kgo@grant-olson.net>
Date: Tue, 21 Feb 2023 12:13:46 -0500
Subject: [PATCH 4/4] Make USB setup api more consistent with other peripherals

---
 components/mailbox/include/oblfr_usb_peripheral.h | 3 ++-
 components/mailbox/src/oblfr_mailbox.c            | 5 ++++-
 components/mailbox/src/oblfr_usb_peripheral.c     | 4 +++-
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/components/mailbox/include/oblfr_usb_peripheral.h b/components/mailbox/include/oblfr_usb_peripheral.h
index 3df3fed..6218280 100644
--- a/components/mailbox/include/oblfr_usb_peripheral.h
+++ b/components/mailbox/include/oblfr_usb_peripheral.h
@@ -38,8 +38,9 @@
 #ifndef __OBLFR_USBPHY_H__
 
 #include <stdint.h>
+#include "oblfr_common.h"
 
-void oblfr_usb_peripheral_init(void);
+oblfr_err_t setup_usb_peripheral(void);
 
 // SUBSYSTEMS
 #define BLFB_USB_BASE ((uint32_t)0x20072000)
diff --git a/components/mailbox/src/oblfr_mailbox.c b/components/mailbox/src/oblfr_mailbox.c
index 44e4a1a..4971c16 100644
--- a/components/mailbox/src/oblfr_mailbox.c
+++ b/components/mailbox/src/oblfr_mailbox.c
@@ -417,7 +417,10 @@ oblfr_err_t oblfr_mailbox_init()
 #endif
 
 #ifdef CONFIG_COMPONENT_MAILBOX_IRQFWD_USB
-    oblfr_usb_peripheral_init();
+    if (setup_usb_peripheral() != SUCCESS) {
+        LOG_E("Failed to setup USB peripheral\r\n");
+        return OBLFR_ERR_ERROR;
+    }
 #endif
     
     return OBLFR_OK;
diff --git a/components/mailbox/src/oblfr_usb_peripheral.c b/components/mailbox/src/oblfr_usb_peripheral.c
index b665424..2dc719b 100644
--- a/components/mailbox/src/oblfr_usb_peripheral.c
+++ b/components/mailbox/src/oblfr_usb_peripheral.c
@@ -43,7 +43,7 @@
 // Enable USB A mode instead of B
 #define USB_HOST
 
-void oblfr_usb_peripheral_init(void)
+oblfr_err_t setup_usb_peripheral(void)
 {
     uint32_t regval;
 
@@ -109,5 +109,7 @@ void oblfr_usb_peripheral_init(void)
     putreg32(regval, BFLB_PDS_BASE + PDS_USB_CTL_OFFSET);
 
     bflb_mtimer_delay_ms(10);
+
+    return OBLFR_OK;
 }
 
-- 
2.34.1

